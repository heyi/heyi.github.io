<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link rel="stylesheet" href="/css/core.css" media="screen" />
  <title>叶子绿的天空</title>
</head>

<body>

  <div class="wrapper">
    <div id="sidebar">
      <p>一个靠谱的前端,一个追求梦想的北漂...</p>
      <div id="search">
        <input type="text" id="search-query" name="q" placeholder="站内搜索" autocomplete="off">
      </div>

      <section id="search-results" style="display: none;">
      <div class="entries"> </div>
      </section>

      <h3>最新文章</h3>
      <hr/>
      <ul>
        <ul style='list-style:none;margin:0px;padding:0px;'>
          
          <li>
          <a href="/webapp/experience/2014/08/06/index.html">实现无缝Carousel</a>
          </li>
          
          <li>
          <a href="/port/2014/07/03/index.html">医院微站接口数据</a>
          </li>
          
          <li>
          <a href="/webapp/experience/2014/07/02/index.html">访名医官网开发教程</a>
          </li>
          
          <li>
          <a href="/webapp/experience/2014/07/01/index.html">移动开发个人总结</a>
          </li>
          
        </ul>
      </ul>

    </div>
    <div id="content">
      <article>
  <h1>实现无缝Carousel</h1>
  <div class="info">
    <span class='tag-label'>标签: </span>
    <ul class="tag-list">
      
      <li>
        experience
      </li>
      
      <li>
        angular
      </li>
      
    </ul>
  </div>
	<hr/>
	<p>最近一段时间我在重构<a href="http://fangmingyi.com/#/">访名医官网</a>,多了很多动画，设计也更精美。 其中有一个就是实现无缝Carousel, 结合angularjs ，我想应该是很简单的吧。之前也看过不少这方面的资料，但总是不理解，一直压在心里,成了心结了。正好，借这次机会，彻底了解下。</p>

<p>淘宝网首页，就有这方面的完美例子，打开开发工具，仔细观察了布局和变化后，我写下了结论。 “帧布局是5-1-2-3-4-5-1,猜测是在跳转到最后一帧的时候，取消了transition,同时快速定位到第一幁，再加上transition属性，这样肉眼就看不出来。感觉无限滚动一样。”,我问了群里的朋友，一位朋友用<a href="http://jsbin.com/pudiruwo/3/edit">例子</a>证实了我的猜测，这大大增强了我的信心。</p>

<p>以前的项目，我用过<a href="https://github.com/revolunet/angular-carousel">angular-carousel</a>,不是无缝实现，而且用起来也感觉不好，多了不可控的因素，但实现源码还是值得一看的，很有启发。</p>

<p>所以决定自己实现一个，花了大约一天的时间，反复测试后，终于OK了。</p>

<h2 id="directive_simplecarousel_">Directive simpleCarousel 的实现</h2>
<div class='highlight'><pre><code class='javascript'><span class='c1'>//todo 参考angular-carousel 实现动态width</span>
<span class='nx'>app</span><span class='p'>.</span><span class='nx'>directive</span><span class='p'>(</span><span class='s1'>&#39;simpleCarousel&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>fmyApi</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>return</span> <span class='p'>{</span>
    <span class='nx'>restrict</span><span class='o'>:</span> <span class='s1'>&#39;A&#39;</span><span class='p'>,</span>
    <span class='nx'>scope</span> <span class='o'>:</span> <span class='p'>{</span> <span class='nx'>slideIndex</span> <span class='o'>:</span> <span class='s2'>&quot;=&quot;</span> <span class='p'>},</span>
    <span class='nx'>link</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$scope</span><span class='p'>,</span> <span class='nx'>element</span><span class='p'>,</span> <span class='nx'>attrs</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='c1'>//3-1-2-3-1 实现双向无缝滚动</span>
      <span class='c1'>// detect supported CSS property</span>
      <span class='kd'>var</span> <span class='nx'>transformProperty</span> <span class='o'>=</span> <span class='s1'>&#39;transform&#39;</span><span class='p'>;</span>
      <span class='kd'>var</span> <span class='nx'>transitionProperty</span> <span class='o'>=</span> <span class='s2'>&quot;transition&quot;</span><span class='p'>;</span>

      <span class='kd'>var</span> <span class='nx'>prefix</span> <span class='o'>=</span> <span class='p'>[</span><span class='s1'>&#39;webkit&#39;</span><span class='p'>,</span> <span class='s1'>&#39;Moz&#39;</span><span class='p'>,</span> <span class='s1'>&#39;O&#39;</span><span class='p'>,</span> <span class='s1'>&#39;ms&#39;</span><span class='p'>];</span>
      <span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>i</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='nx'>i</span> <span class='o'>&lt;</span> <span class='nx'>prefix</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span> <span class='nx'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>e</span> <span class='o'>=</span> <span class='nx'>prefix</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span> <span class='o'>+</span> <span class='s2'>&quot;Transform&quot;</span><span class='p'>;</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='k'>typeof</span> <span class='nb'>document</span><span class='p'>.</span><span class='nx'>body</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>e</span><span class='p'>]</span> <span class='o'>!==</span> <span class='s1'>&#39;undefined&#39;</span><span class='p'>)</span> <span class='p'>{</span>
          <span class='nx'>transformProperty</span> <span class='o'>=</span> <span class='nx'>e</span><span class='p'>;</span>
          <span class='nx'>transitionProperty</span> <span class='o'>=</span> <span class='nx'>prefix</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span> <span class='o'>+</span> <span class='s2'>&quot;Transition&quot;</span><span class='p'>;</span>
          <span class='k'>break</span><span class='p'>;</span>
        <span class='p'>}</span>
      <span class='p'>};</span>

      <span class='kd'>var</span> <span class='nx'>transV</span> <span class='o'>=</span> <span class='s2'>&quot;transform .25s ease&quot;</span><span class='p'>;</span>
      <span class='k'>if</span> <span class='p'>(</span><span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe9</span> <span class='o'>||</span> <span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe8</span><span class='p'>)</span> <span class='p'>{</span>
         <span class='nx'>transV</span> <span class='o'>=</span> <span class='s2'>&quot;margin-left .25s ease&quot;</span><span class='p'>;</span>
      <span class='p'>}</span>

      <span class='kd'>var</span> <span class='nx'>childrens</span> <span class='o'>=</span> <span class='nx'>element</span><span class='p'>.</span><span class='nx'>children</span><span class='p'>(),</span> <span class='nx'>l</span> <span class='o'>=</span> <span class='nx'>childrens</span><span class='p'>.</span><span class='nx'>length</span><span class='p'>;</span>
      <span class='kd'>var</span> <span class='nx'>l</span> <span class='o'>=</span> <span class='nx'>element</span><span class='p'>.</span><span class='nx'>children</span><span class='p'>().</span><span class='nx'>length</span><span class='p'>;</span>
      <span class='kd'>var</span> <span class='nx'>firstC</span> <span class='o'>=</span> <span class='nx'>angular</span><span class='p'>.</span><span class='nx'>element</span><span class='p'>(</span><span class='nx'>childrens</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]),</span> <span class='nx'>lastC</span> <span class='o'>=</span> <span class='nx'>angular</span><span class='p'>.</span><span class='nx'>element</span><span class='p'>(</span><span class='nx'>childrens</span><span class='p'>[</span><span class='nx'>l</span> <span class='o'>-</span> <span class='mi'>1</span><span class='p'>]);</span>
      <span class='kd'>var</span> <span class='nx'>w</span> <span class='o'>=</span> <span class='nx'>firstC</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>clientWidth</span><span class='p'>;</span>
      <span class='nx'>element</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='nx'>firstC</span><span class='p'>.</span><span class='nx'>clone</span><span class='p'>()).</span><span class='nx'>prepend</span><span class='p'>(</span><span class='nx'>lastC</span><span class='p'>.</span><span class='nx'>clone</span><span class='p'>());</span>

      <span class='nx'>$scope</span><span class='p'>.</span><span class='nx'>$watch</span><span class='p'>(</span><span class='s2'>&quot;slideIndex&quot;</span><span class='p'>,</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>nvalue</span><span class='p'>,</span><span class='nx'>ovalue</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>transitionProperty</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>transV</span><span class='p'>;</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe8</span> <span class='o'>||</span> <span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe9</span><span class='p'>)</span> <span class='p'>{</span>
          <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='s2'>&quot;marginLeft&quot;</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;-&quot;</span> <span class='o'>+</span> <span class='p'>(</span><span class='nx'>nvalue</span> <span class='o'>+</span> <span class='mi'>1</span><span class='p'>)</span> <span class='o'>*</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px&quot;</span><span class='p'>;</span>
        <span class='p'>}</span><span class='k'>else</span> <span class='p'>{</span>
          <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>transformProperty</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;translate3d(-&quot;</span> <span class='o'>+</span> <span class='p'>(</span> <span class='nx'>nvalue</span> <span class='o'>+</span> <span class='mi'>1</span> <span class='p'>)</span> <span class='o'>*</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px,0,0)&quot;</span> <span class='p'>;</span>
        <span class='p'>}</span>

        <span class='k'>if</span> <span class='p'>(</span><span class='nx'>nvalue</span> <span class='o'>==</span> <span class='nx'>l</span> <span class='o'>||</span> <span class='nx'>nvalue</span> <span class='o'>==</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>)</span> <span class='p'>{</span>
          <span class='nx'>element</span><span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s2'>&quot;transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd&quot;</span><span class='p'>,</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span>
            <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>transitionProperty</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;none&quot;</span><span class='p'>;</span>
            <span class='k'>if</span> <span class='p'>(</span><span class='nx'>nvalue</span> <span class='o'>==</span> <span class='nx'>l</span><span class='p'>)</span> <span class='p'>{</span>
              <span class='k'>if</span> <span class='p'>(</span><span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe8</span> <span class='o'>||</span> <span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe9</span><span class='p'>)</span> <span class='p'>{</span>
                <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='s2'>&quot;marginLeft&quot;</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;-&quot;</span> <span class='o'>+</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px&quot;</span><span class='p'>;</span>
              <span class='p'>}</span><span class='k'>else</span> <span class='p'>{</span>
                <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>transformProperty</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;translate3d(-&quot;</span> <span class='o'>+</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px,0,0)&quot;</span> <span class='p'>;</span>
              <span class='p'>}</span>
            <span class='p'>}</span><span class='k'>else</span> <span class='p'>{</span>
              <span class='k'>if</span> <span class='p'>(</span><span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe8</span> <span class='o'>||</span> <span class='nx'>fmyApi</span><span class='p'>.</span><span class='nx'>isIe9</span><span class='p'>)</span> <span class='p'>{</span>
                <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='s2'>&quot;marginLeft&quot;</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;-&quot;</span> <span class='o'>+</span> <span class='nx'>l</span> <span class='o'>*</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px&quot;</span><span class='p'>;</span>
              <span class='p'>}</span><span class='k'>else</span> <span class='p'>{</span>
                <span class='nx'>element</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>style</span><span class='p'>[</span><span class='nx'>transformProperty</span><span class='p'>]</span> <span class='o'>=</span> <span class='s2'>&quot;translate3d(-&quot;</span> <span class='o'>+</span> <span class='nx'>l</span> <span class='o'>*</span> <span class='nx'>w</span> <span class='o'>+</span> <span class='s2'>&quot;px,0,0)&quot;</span> <span class='p'>;</span>
              <span class='p'>}</span>
            <span class='p'>}</span>
            <span class='nx'>element</span><span class='p'>.</span><span class='nx'>off</span><span class='p'>(</span><span class='s2'>&quot;transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd&quot;</span><span class='p'>);</span>
          <span class='p'>});</span>
        <span class='p'>}</span>

      <span class='p'>});</span>
    <span class='p'>}</span>
  <span class='p'>};</span>
<span class='p'>});</span>
</code></pre></div>
<h2 id="">页面布局</h2>
<div class='highlight'><pre><code class='html'>      <span class='nt'>&lt;div</span> <span class='na'>class=</span><span class='s'>&#39;carousel-wrapper&#39;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;ul</span> <span class='na'>class=</span><span class='s'>&quot;carousel-cnt&quot;</span> <span class='na'>simple-carousel</span> <span class='na'>slide-index=</span><span class='s'>&#39;car1&#39;</span> <span class='na'>ng-class=</span><span class='s'>&#39;[car1Active,&quot;c&quot; + car1]&#39;</span><span class='nt'>&gt;</span>
        ...
        <span class='nt'>&lt;/ul&gt;</span>
        <span class='nt'>&lt;img</span> <span class='na'>class=</span><span class='s'>&#39;prev&#39;</span> <span class='na'>src=</span><span class='s'>&quot;images/v2/left.png&quot;</span> <span class='na'>alt=</span><span class='s'>&quot;left&quot;</span> <span class='na'>ng-click=</span><span class='s'>&#39;direct(&quot;car1&quot;,-1)&#39;</span><span class='nt'>&gt;</span>
        <span class='nt'>&lt;img</span> <span class='na'>class=</span><span class='s'>&#39;next&#39;</span> <span class='na'>src=</span><span class='s'>&quot;images/v2/right.png&quot;</span>  <span class='na'>alt=</span><span class='s'>&quot;right&quot;</span> <span class='na'>ng-click=</span><span class='s'>&#39;direct(&quot;car1&quot;,1)&#39;</span><span class='nt'>&gt;</span>
      <span class='nt'>&lt;/div&gt;</span>
</code></pre></div>
<h2 id="_2">控制器</h2>
<div class='highlight'><pre><code class='js'><span class='nx'>app</span><span class='p'>.</span><span class='nx'>controller</span><span class='p'>(</span><span class='s1'>&#39;indexCtrl&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>$scope</span><span class='p'>,</span> <span class='nx'>$timeout</span><span class='p'>,</span> <span class='nx'>fmyApi</span><span class='p'>)</span> <span class='p'>{</span>
<span class='p'>...</span>
  <span class='nx'>$scope</span><span class='p'>.</span><span class='nx'>car1</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
  <span class='nx'>$scope</span><span class='p'>.</span><span class='nx'>car2</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>

  <span class='nx'>$scope</span><span class='p'>.</span><span class='nx'>direct</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>car</span><span class='p'>,</span> <span class='nx'>step</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>tt</span> <span class='o'>=</span> <span class='nx'>$scope</span><span class='p'>[</span><span class='nx'>car</span><span class='p'>]</span> <span class='o'>+</span> <span class='nx'>step</span><span class='p'>;</span>
    <span class='k'>if</span> <span class='p'>(</span> <span class='nx'>tt</span> <span class='o'>==</span> <span class='o'>-</span><span class='mi'>2</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='nx'>tt</span> <span class='o'>=</span> <span class='mi'>1</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='k'>if</span> <span class='p'>(</span> <span class='nx'>tt</span> <span class='o'>==</span> <span class='mi'>4</span> <span class='p'>)</span> <span class='p'>{</span>
      <span class='nx'>tt</span> <span class='o'>=</span> <span class='mi'>1</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='nx'>$scope</span><span class='p'>[</span><span class='nx'>car</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>tt</span><span class='p'>;</span>
  <span class='p'>};</span>
<span class='p'>...</span>
<span class='p'>});</span>
</code></pre></div>
	<a href="http://heyi.github.io">返回首页</a>
	<span class='fr'>
		06 August 2014
	</span>
  <!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/webapp/experience/2014/08/06/index" data-title="实现无缝Carousel" data-url="/webapp/experience/2014/08/06/index.html"></div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
    var duoshuoQuery = {
      short_name: "heyi"
    };
    (function()
    {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';
      ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.unstable.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
  <!-- 多说公共JS代码 end -->
</article>

    </div>
  </div>

  <div class='footer'>
    <p>Projects by <a href="https://github.com/heyi">heyi</a> can be found on <a href="https://github.com/heyi">GitHub</a>
    </p>
  </div>
  <script src="/js/search.min.js" type="text/javascript" charset="utf-8"></script>
  
  <script id="search-results-template" type="text/mustache">
    {{#entries}}
    <article>
    <h3>
      <a href="{{url}}">{{title}}</a>
      {{#date}}<small><time datetime="{{pubdate}}" pubdate>{{displaydate}}</time></small>{{/date}}
    </h3>
    </article>
    {{/entries}}
  </script>
  
  <script type="text/javascript">
    $(function() { $('#search-query').lunrSearch({ indexUrl: '/search.json', results:  '#search-results', entries:  '.entries',      template: '#search-results-template' }); });
  </script>
</body>
</html>